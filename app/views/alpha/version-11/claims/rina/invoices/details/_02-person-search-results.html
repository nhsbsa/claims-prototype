<!-- ADDING CUSTOM CSS - Add your custom CSS or Sass in /app/assets/sass/main.scss -->

{% set mainNavigation = [
    {
    name: 'Summary',
    path: '/alpha/version-11/claims/claim/{{ claim.claimid }}/summary/active-invoices-uploaded'
    },
    {
    name: 'Invoices',
    path: '/alpha/version-11/claims/claim/{{ claim.claimid }}/invoices/full-invoice-list'
    },
    {
    name: 'Contestations',
    path: ''
    },
    {
    name: 'Notes',
    path: ''
    },
    {
    name: 'History',
    path: ''
    }
    ]
%}

<!-- Extends the layout from /views/layout-full-width-claim.html -->
{% extends 'layout-full-width-invoice-poc.html' %}
<!-- 
    In /views/layout.html you can:
    - change the header and footer 
    - add custom CSS and JavaScript
-->

<!-- Start of page title -->
{% block pageTitle %}
Invoice details - Manage incoming international healthcare claims - NHSBSA
{% endblock %}
<!-- End of page title -->

{% block beforeContent %}
<!-- Start of breadcrumb -->
<nav class="nhsuk-breadcrumb" aria-label="Breadcrumb">
    <div class="nhsuk-width-container-fluid">
        <ol class="nhsuk-breadcrumb__list">
            <li class="nhsuk-breadcrumb__item"><a class="nhsuk-breadcrumb__link" href="../../../../../../../home">Home</a></li>
            <li class="nhsuk-breadcrumb__item"><a class="nhsuk-breadcrumb__link" href="../../../../../../index">Claims</a></li>
            <li class="nhsuk-breadcrumb__item"><a class="nhsuk-breadcrumb__link" href="../../../summary/claim-summary/{{ invoice.claimid }}">Claim ID {{ invoice.claimid }}</a></li>
            <li class="nhsuk-breadcrumb__item"><a class="nhsuk-breadcrumb__link" href="../../../invoices/full-invoice-list">Invoices</a></li>
            <li class="nhsuk-breadcrumb__item"><a class="nhsuk-breadcrumb__link" href="../../../invoices/details/01-to-check/{{ invoice.invoiceid }}">Invoice ID {{ invoice.invoiceid }}</a></li>
        </ol>
        <p class="nhsuk-breadcrumb__back">
            <a class="nhsuk-breadcrumb__backlink" href="../../../../../../index">
                <span class="nhsuk-u-visually-hidden">Back to &nbsp;</span>
                Claims
            </a>
        </p>
    </div>
</nav>
<!-- End of breadcrumb -->
{% endblock %}

<!-- Start of central content -->
{% block content %}

<style>
    .app-link--copy,
    .app-link--copy:link,
    .app-link--copy:active,
    .app-link--copy:visited,
    .app-link--copy:hover {
        -moz-osx-font-smoothing: grayscale;
        -webkit-font-smoothing: antialiased;
        border-bottom-color: #007f3b;
        box-shadow: 0 2px 0 #007f3b;
        margin-bottom: 16px;
        text-transform: none;
        background-color: #fff;
        border: 1px solid #007f3b;
        color: #007f3b;
        font-size: 16px;
        font-weight: 400;
        padding: 4px 10px;
        text-align: center;
        text-decoration: none;
    }

    .nhsuk-card--secondary {
        background: rgba(0, 0, 0, 0);
        border-bottom: 4px solid #d8dde0;
        border-left: 0;
        border-right: 0;
        border-top: 0
    }

    .nhsuk-card__content--secondary {
        padding-left: 0;
        padding-right: 0;
        padding-top: 0
    }
</style>

<!-- Debugging: Dumping data for invoice and search results -->
<!-- <pre>{{ invoice | dump }}</pre>
<pre>{{ searchResults | dump }}</pre>
<pre>{{ queryParams | dump }}</pre> -->


<!-- Start of back link -->
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <div class="nhsuk-back-link">
            <a class="nhsuk-back-link__link" href="01-to-check">
                <svg class="nhsuk-icon nhsuk-icon__chevron-left" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                    aria-hidden="true" height="24" width="24">
                    <path
                        d="M8.5 12c0-.3.1-.5.3-.7l5-5c.4-.4 1-.4 1.4 0s.4 1 0 1.4L10.9 12l4.3 4.3c.4.4.4 1 0 1.4s-1 .4-1.4 0l-5-5c-.2-.2-.3-.4-.3-.7z">
                    </path>
                </svg>
                Go back to invoice ID {{ invoice.country }}
            </a>
        </div>
    </div>
</div>
<!-- End of back link -->

<!-- Start of header block -->
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <h1 class="nhsuk-heading-xl nhsuk-u-margin-bottom-5">
            Person search
        </h1>
    </div>
</div>
<!-- End of header block -->

<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <div class="nhsuk-hint" id="example-with-hint-text-hint">
            Search for a person to match to the invoice. You can use the invoice details to help you find a match.
        </div>
    </div>
</div>

<!-- Start person search -->
<div class="nhsuk-grid-row" id="search-criteria">
    <div class="nhsuk-grid-column-three-quarters">

        <!-- Start search criteria expander -->
        <details class="nhsuk-details nhsuk-expander">
            <summary class="nhsuk-details__summary">
                <span class="nhsuk-details__summary-text">Search criteria</span>
            </summary>
            <div class="nhsuk-details__text">
                <form action="/alpha/version-11/personFilterSearch" method="post">

                    <div class="nhsuk-form-group">
                        <label class="nhsuk-label--s" for="last-name">Last name</label>
                        <input class="nhsuk-input" id="last-name" name="lastName" type="text" {% if data['lastName'] %}value="{{ data['lastName'] }}" {% endif %}>
                    </div>

                    <div class="nhsuk-form-group">
                        <label class="nhsuk-label--s" for="first-name">First name</label>
                        <input class="nhsuk-input" id="first-name" name="firstName" type="text" {% if data['firstName'] %}value="{{ data['firstName'] }}" {% endif %}>
                    </div>

                    <div class="nhsuk-form-group">
                        <label class="nhsuk-label--s" for="residence-country">Residential country</label>
                        <input class="nhsuk-input" id="residence-country" name="residenceCountry" type="text" {% if data['residenceCountry'] %}value="{{ data['residenceCountry'] }}" {% endif %}>
                    </div>

                    <div class="nhsuk-form-group">
                        <fieldset class="nhsuk-fieldset">
                            <label class="nhsuk-label--s" for="dob">Date of birth</label>
                            <div class="nhsuk-date-input">
                                <div class="nhsuk-date-input__item">
                                    <div class="nhsuk-form-group">
                                        <label class="nhsuk-label" for="dob-day">Day</label>
                                        <input class="nhsuk-input nhsuk-input--width-2" id="dob-day" name="day" type="text" pattern="[0-9]*" inputmode="numeric" {% if data['day'] %}value="{{ data['day'] }}" {% endif %}>
                                    </div>
                                </div>
                                <div class="nhsuk-date-input__item">
                                    <div class="nhsuk-form-group">
                                        <label class="nhsuk-label" for="dob-month">Month</label>
                                        <input class="nhsuk-input nhsuk-input--width-2" id="dob-month" name="month" type="text" pattern="[0-9]*" inputmode="numeric" {% if data['month'] %}value="{{ data['month'] }}" {% endif %}>
                                    </div>
                                </div>
                                <div class="nhsuk-date-input__item">
                                    <div class="nhsuk-form-group">
                                        <label class="nhsuk-label" for="dob-year">Year</label>
                                        <input class="nhsuk-input nhsuk-input--width-4" id="dob-year" name="year" type="text" pattern="[0-9]*" inputmode="numeric" {% if data['year'] %}value="{{ data['year'] }}" {% endif %}>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <div class="nhsuk-hint">Or search using one unique identifier.</div>

                    <div class="nhsuk-form-group">
                        <label class="nhsuk-label--s" for="unique-id">Person unique ID</label>
                        <div class="nhsuk-hint">Reference, National insurance number or NHS number.</div>
                        <input class="nhsuk-input" id="unique-id" name="uniqueID" type="text" {% if data['uniqueID'] %}value="{{ data['uniqueID'] }}" {% endif %}>
                    </div>

                    <div class="nhsuk-form-group">
                        <label class="nhsuk-label--s" for="issue-number">Entitlement issue number</label>
                        <div class="nhsuk-hint">EHIC, GHIC, or PRC issue number.</div>
                        <input class="nhsuk-input" id="issue-number" name="issueNumber" type="text" {% if data['issueNumber'] %}value="{{ data['issueNumber'] }}" {% endif %}>
                    </div>
                    
                    <button class="nhsuk-button nhsuk-u-margin-bottom-3" type="submit" style="margin-top: 20px;">
                        Search
                    </button>

                </form>
            </div>
        </details>
        <!-- End search criteria expander-->

        <div class="nhsuk-card">
            <div class="nhsuk-card__content">
                {% if searchResults and searchResults.length > 0 %}
                <!-- Start of header block -->
                <div class="nhsuk-grid-row nhsuk-u-padding-bottom-2">
                    <div class="nhsuk-grid-column-two-thirds">
                        <h3 class="nhsuk-heading-m">Showing {{ searchResults.length }} results of {{ totalPersons }}</h3>
                        <p>
                            {% if data['lastName'] %}
                            <strong class="nhsuk-tag nhsuk-tag--aqua-green">{{ data['lastName'] }}</strong>
                            {% endif %}
                            {% if data['firstName'] %}
                            <strong class="nhsuk-tag nhsuk-tag--aqua-green">{{ data['firstName'] }}</strong>
                            {% endif %}
                            {% if data['residenceCountry'] %}
                            <strong class="nhsuk-tag nhsuk-tag--aqua-green">{{ data['residenceCountry'] }}</strong>
                            {% endif %}
                            {% if data['day'] and data['month'] and data['year'] %}
                            <strong class="nhsuk-tag nhsuk-tag--aqua-green">{{ data['day'] }} {{ data['month'] }} {{ data['year'] }}</strong>
                            {% elif not data['day'] and not data['month'] and data['year'] %}
                            <strong class="nhsuk-tag nhsuk-tag--aqua-green">{{ data['year'] }}</strong>
                            {% elif not data['day'] and data['month'] and data['year'] %}
                            <strong class="nhsuk-tag nhsuk-tag--aqua-green">{{ data['month'] }} {{ data['year'] }}</strong>
                            {% endif %}
                            {% if data['uniqueID'] %}
                            <strong class="nhsuk-tag nhsuk-tag--aqua-green">{{ data['uniqueID'] }}</strong>
                            {% endif %}
                            {% if data['issueNumber'] %}
                            <strong class="nhsuk-tag nhsuk-tag--aqua-green">{{ data['issueNumber'] }}</strong>
                            {% endif %}
                        </p>
                    </div>
                    <div class="nhsuk-grid-column-one-third">
                        <div class="nhsuk-form-group" style="float:right;">
                            <label class="nhsuk-label" for="results">Results per page</label>
                            <select class="nhsuk-select" id="results" name="results">
                                <option value="10" {% if limit == 10 %}selected{% endif %}>10</option>
                                <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                                <option value="200" {% if limit == 200 %}selected{% endif %}>200</option>
                            </select>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Start person search results -->
                <div class="nhsuk-grid-row" id="search-results">
                    <div class="nhsuk-grid-column-full">
                        <table role="table" class="nhsuk-table-responsive nhsuk-u-margin-bottom-6">
                            <thead role="rowgroup" class="nhsuk-table__head">
                                <tr role="row">
                                    <th role="columnheader">Last name</th>
                                    <th role="columnheader">First name</th>
                                    <th role="columnheader">Date of birth</th>
                                    <th role="columnheader">NINO</th>
                                    <th role="columnheader">Reference</th>
                                    <th role="columnheader">View</th>
                                </tr>
                            </thead>
                            <tbody class="nhsuk-table__body">
                            {% if searchResults and searchResults.length > 0 %}
                                {% for person in searchResults %}
                                <tr role="row">
                                    <td role="cell">{{ person.lastname }}</td>
                                    <td role="cell">{{ person.firstname }}</td>
                                    <td role="cell">{{ person.dob_formatted }}</td> <!-- Now properly formatted -->
                                    <td role="cell">{{ person.nino }}</td>  <!-- Accessing nino -->
                                    <td role="cell">{{ person.ohs }}</td>   <!-- Accessing ohs -->
                                    <td role="cell">
                                        <td role="cell">
                                            <td role="cell">
                                            <a href="/alpha/version-11/claims/rina/invoices/details/_03-person-details?firstname={{ person.firstname }}&lastname={{ person.lastname }}&dob_day={{ person.dob_day }}&dob_month={{ person.dob_month }}&dob_year={{ person.dob_year }}&nino={{ person.nino }}" class="nhsuk-link">
                                            View person
                                            </a>
                                                
                                            </td>

                                        </td>                                        
                                    </td>
                                </tr>
                                {% endfor %}
                            
                            {% else %}
                                <tr>
                                    <td colspan="6">No results found.</td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- End of table data -->

                
                <!-- Start pagination -->
                <div class="nhsuk-grid-row">
                    <div class="nhsuk-grid-column-full">
                        <nav class="nhsuk-pagination" role="navigation" aria-label="Pagination">
                            <div class="nhsuk-pagination__prev">
                                {% if page > 1 %}
                                    <a class="nhsuk-link nhsuk-pagination__link" href="?page={{ page - 1 }}&limit={{ limit }}&lastName={{ queryParams.lastName }}&firstName={{ queryParams.firstName }}&residenceCountry={{ queryParams.residenceCountry }}&day={{ queryParams.dobDay }}&month={{ queryParams.dobMonth }}&year={{ queryParams.dobYear }}&uniqueID={{ queryParams.uniqueID }}&issuePin={{ queryParams.issuePin }}&claimid={{ invoice.claimid }}&invoiceid={{ invoice.invoiceid }}">
                                        <span class="nhsuk-pagination__link-title">Previous</span>
                                    </a>
                                {% endif %}
                            </div>
                            <ul class="nhsuk-pagination__list">
                                {% for i in range(1, totalPages + 1) %}
                                    <li class="nhsuk-pagination__item {% if i == page %}nhsuk-pagination__item--current{% endif %}">
                                        <a class="nhsuk-link nhsuk-pagination__link" href="?page={{ i }}&limit={{ limit }}&lastName={{ queryParams.lastName }}&firstName={{ queryParams.firstName }}&residenceCountry={{ queryParams.residenceCountry }}&day={{ queryParams.dobDay }}&month={{ queryParams.dobMonth }}&year={{ queryParams.dobYear }}&uniqueID={{ queryParams.uniqueID }}&issuePin={{ queryParams.issuePin }}&claimid={{ invoice.claimid }}&invoiceid={{ invoice.invoiceid }}">
                                            {{ i }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                            <div class="nhsuk-pagination__next">
                                {% if page < totalPages %}
                                    <a class="nhsuk-link nhsuk-pagination__link" href="?page={{ page + 1 }}&limit={{ limit }}&lastName={{ queryParams.lastName }}&firstName={{ queryParams.firstName }}&residenceCountry={{ queryParams.residenceCountry }}&day={{ queryParams.dobDay }}&month={{ queryParams.dobMonth }}&year={{ queryParams.dobYear }}&uniqueID={{ queryParams.uniqueID }}&issuePin={{ queryParams.issuePin }}&claimid={{ invoice.claimid }}&invoiceid={{ invoice.invoiceid }}">
                                        <span class="nhsuk-pagination__link-title">Next</span>
                                    </a>
                                {% endif %}
                            </div>
                        </nav>
                    </div>
                </div>
                
                <!-- End pagination -->
                
            </div>
        </div>

    </div>

    <!-- Start of invoice details from submitting country -->
    <div class="nhsuk-grid-column-one-quarter">

    <h2 class="nhsuk-heading-l nhsuk-u-margin-bottom-2">
        Invoice details from {{ invoice.country }}
        <span class="nhsuk-caption-m nhsuk-caption--bottom">Invoice reference: {{ invoice.invoicereference }}</span>
    </h2>
    <hr style="margin:0px 0px 30px 0px;">

    <!-- Start person details-->
    <div class="nhsuk-card nhsuk-card--secondary">
        <div class="nhsuk-card__content nhsuk-card__content--secondary">
            <h3 class="nhsuk-card__heading nhsuk-heading-s nhsuk-u-margin-bottom-1">
                Person details
            </h3>
            <hr style="margin:0px 0px 10px 0px;">
            <dl class="nhsuk-summary-list nhsuk-u-margin-bottom-2">
                <div class="nhsuk-summary-list__row">
                    <dt class="nhsuk-summary-list__key">
                        Last name
                    </dt>
                    <dd class="nhsuk-summary-list__value">
                        {{ invoice.person.lastname }}
                    </dd>
                </div>
                <div class="nhsuk-summary-list__row">
                    <dt class="nhsuk-summary-list__key">
                        First name
                    </dt>
                    <dd class="nhsuk-summary-list__value">
                        {{ invoice.person.firstname }}
                    </dd>
                </div>
                <div class="nhsuk-summary-list__row">
                    <dt class="nhsuk-summary-list__key">
                        Date of birth
                    </dt>
                    <dd class="nhsuk-summary-list__value">
                        {{ invoice.person.dob.formatted }}
                    </dd>
                </div>
                <div class="nhsuk-summary-list__row">
                    <dt class="nhsuk-summary-list__key">
                        Unique ID
                    </dt>
                    <dd class="nhsuk-summary-list__value">
                        {{ invoice.person.uniqueid.nino }}
                    </dd>
                </div>
            </dl>

        </div>
    </div>
    <!-- End person details-->

    <!-- Start entitlement details -->
    {% if invoice.person.entitlements and invoice.person.entitlements.length > 0 %}
    {% set entitlement = invoice.person.entitlements[0] %}
    <div class="nhsuk-card nhsuk-card--secondary">
        <div class="nhsuk-card__content nhsuk-card__content--secondary">
            <h3 class="nhsuk-card__heading nhsuk-heading-s nhsuk-u-margin-bottom-1">
                Entitlement Details
            </h3>
            <hr style="margin:0px 0px 10px 0px;">
    
            <div class="nhsuk-summary-list__row">
                <dt class="nhsuk-summary-list__key">
                    Type
                </dt>
                <dd class="nhsuk-summary-list__value">
                    {{ entitlement.type | default('—') }}
                </dd>
            </div>
            
            <div class="nhsuk-summary-list__row">
                <dt class="nhsuk-summary-list__key">
                    Start date
                </dt>
                <dd class="nhsuk-summary-list__value">
                    {{ entitlement.start | default('—') }}
                </dd>
            </div>
            
            <div class="nhsuk-summary-list__row">
                <dt class="nhsuk-summary-list__key">
                    End date
                </dt>
                <dd class="nhsuk-summary-list__value">
                    {{ entitlement.end | default('—') }}
                </dd>
            </div>
            
            {% if entitlement.issued != 'N/A' %}
            <div class="nhsuk-summary-list__row">
                <dt class="nhsuk-summary-list__key">Issue date</dt>
                <dd class="nhsuk-summary-list__value">{{ entitlement.issued | default('—') }}</dd>
            </div>
            {% endif %}
            
            {% if entitlement.issuenumber %}
            <div class="nhsuk-summary-list__row">
                <dt class="nhsuk-summary-list__key">
                    Issue number
                </dt>
                <dd class="nhsuk-summary-list__value">
                    {{ entitlement.issuenumber | default('—') }}
                </dd>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}


    <!-- End entitlement details-->

    <!-- Start invoice period and amount-->
    <div class="nhsuk-card nhsuk-card--secondary">
        <div class="nhsuk-card__content nhsuk-card__content--secondary">
            <h3 class="nhsuk-card__heading nhsuk-heading-s nhsuk-u-margin-bottom-1">
                Invoice period and amount
            </h3>
            <hr style="margin:0px 0px 10px 0px;">
            <dl class="nhsuk-summary-list">
                <div class="nhsuk-summary-list__row">
                    <dt class="nhsuk-summary-list__key">
                        Start date
                    </dt>
                    <dd class="nhsuk-summary-list__value">
                        {{ invoice.startdate }}
                    </dd>
                </div>
                <div class="nhsuk-summary-list__row">
                    <dt class="nhsuk-summary-list__key">
                        End date
                    </dt>
                    <dd class="nhsuk-summary-list__value">
                        {{ invoice.enddate }}
                    </dd>
                </div>
                <div class="nhsuk-summary-list__row">
                    <dt class="nhsuk-summary-list__key">
                        Total amount
                    </dt>
                    <dd class="nhsuk-summary-list__value">
                        {{ invoice.amount }}
                    </dd>
                </div>
            </dl>

        </div>
    </div>
    <!-- End invoice period and amount-->

</div>
<!-- End of invoice details from submitting country -->

</div>

{% endblock %}
<!-- End of central content -->
